<!DOCTYPE html>
<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.js" integrity="sha256-DrT5NfxfbHvMHux31Lkhxg42LY6of8TaYyK50jnxRnM=" crossorigin="anonymous"></script>
    </head>
    <body>
        <h1>insomnia</h1>
        <canvas id="ctx" width="1280" height="720" style="border:1px solid #000000;">
            Your browser does not support the HTML canvas tag.
        </canvas>
        <p id = "ammo"></p>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
        <script>
            var c = document.getElementById("ctx");
            var ctx = c.getContext("2d");
            const socket = io('http://localhost:3000');
            const WIDTH = 1280;
            const HEIGHT = 720;

            var id;
            socket.on('id', (data) => {
                id = data.id;
            });

            //handle cursor
            var mx = 0;
            var my = 0;
            //handle keys
            var keyArray = [0, 0, 0, 0, 0]; //w, a, s, d, space
            socket.on('state', (data) => {
                //send key data
                var packet = {};
                packet.keyArray = keyArray;
                socket.emit('keyPress', packet);
                //send mouse data
                packet = {
                    x: mx,
                    y: my
                };
                socket.emit('cursorMove', packet);
                //console.log(data);
                //parse data
                var enemyList = data.enemyList;
                ctx.clearRect(0, 0, WIDTH, HEIGHT);
                ctx.fillStyle = 'red';
                for(var enemy in enemyList) {
                    ctx.fillText('enemy', enemyList[enemy].x-25, enemyList[enemy].y-30);
                    ctx.fillRect(enemyList[enemy].x-25, enemyList[enemy].y-25, 50, 50);
                    //console.log(enemy.x);
                }
                //parse data
                var playerList = data.playerList;
                ctx.fillStyle = 'green';
                for(var player in playerList) {
                    ctx.fillRect(playerList[player].x-16, playerList[player].y-16, 32, 32);
                }
                //parse data
                var projectileList = data.projectileList;
                //console.log(projectileList);
                for(var proj in projectileList) {
                    ctx.fillRect(projectileList[proj].x - projectileList[proj].dim/2, 
                    projectileList[proj].y - projectileList[proj].dim/2, projectileList[proj].dim, projectileList[proj].dim);
                }
                //display ammo
                $('#ammo').empty();
                $('#ammo').append(playerList[id].ammo);
            });
            //handle mouse
            c.addEventListener('mousemove', (event) => {
                var rect = c.getBoundingClientRect();
                mx = event.clientX - rect.left;
                my = event.clientY - rect.top;
            });
            //handle keys
            document.onkeydown = (event) => {
                if(event.keyCode === 87) {
                    keyArray[0] = 1;
                }
                if(event.keyCode === 65) {
                    keyArray[1] = 1;
                }
                if(event.keyCode === 83) {
                    keyArray[2] = 1;
                }
                if(event.keyCode === 68) {
                    keyArray[3] = 1;
                }
                if(event.keyCode == 32) {
                    keyArray[4] = 1;
                }
            }
            document.onkeyup = (event) => {
                if(event.keyCode === 87) {
                    keyArray[0] = 0;
                }
                if(event.keyCode === 65) {
                    keyArray[1] = 0;
                }
                if(event.keyCode === 83) {
                    keyArray[2] = 0;
                }
                if(event.keyCode === 68) {
                    keyArray[3] = 0;
                }
                if(event.keyCode == 32) {
                    keyArray[4] = 0;
                }
            }
        </script>
    </body>
</html>